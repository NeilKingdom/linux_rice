#!/bin/sh
#
# Description: This script parses input for valid URIs. Input can include the user's history file,
# direct input from stdin, or input from a given file. If more than one URIs are found
# in a given file, they are piped to dmenu. The script opens the located resource using xdg-open.
# Dependencies: xdg-open

REGEX="https?://\S+"
USE_HISTORY=0

usage() {
    printf "%s\n" \
        "Usage: gotourl [-h] [-y] [file | url]" \
        "-h    Show help" \
        "-y    Search last 10 shell history entries"
}

# Parse options
while getopts "hy" opt; do
    case "$opt" in
        h) usage && exit 0
            ;;
        y) USE_HISTORY=1
            ;;
        *) usage && exit 1
            ;;
    esac
done
shift $((OPTIND - 1))

if [ "$USE_HISTORY" -eq 1 ]; then
    # TODO: No POSIX compliant way to get history. Have user specify hist location
    URLS=
    if [ -z "$URLS" ]; then
        echo "No URLs found in last 10 commands of history" >&2
        exit 1
    fi
elif [ "$#" -gt 0 ]; then
    if [ -f "$1" ]; then
        # Extract URLs from file
        URLS="$(grep -Eo "$REGEX" "$1")"
        if [ -z "$URLS" ]; then
            echo "No URLs found in file $1" >&2
            exit 1
        fi
    else
        # Treat argument as raw URL
        if echo "$1" | grep -Eq "^$REGEX$"; then
            URL="$1"
        else
            # Extract URLs from the string if multiple
            URLS="$(echo "$1" | grep -Eo "$REGEX")"
            if [ -z "$URLS" ]; then
                echo "No valid URLs found in input" >&2
                exit 1
            fi
        fi
    fi
else
    # Interactive input
    printf "Enter file, URL, or text containing URLs: "; read -r INPUT
    URLS="$(echo "$INPUT" | grep -Eo "$REGEX")"
    if [ -z "$URLS" ]; then
        echo "No URLs found in input" >&2
        exit 1
    fi
fi

# If URL not already set (raw single URL), prompt user if multiple URLs found
if [ -z "$URL" ]; then
    URL="$(echo "$URLS" | dmenu -p "Select URL" -l 10)"
    [ -z "$URL" ] && echo "No URL selected" >&2 && exit 1
fi

xdg-open "$URL"
